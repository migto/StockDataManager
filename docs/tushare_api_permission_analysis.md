# Tushare API权限分析和解决方案

## 权限测试结果

根据API测试结果，发现用户的免费Tushare Token存在以下权限限制：

### 权限状态
| 接口名称 | 权限状态 | 限制描述 |
|----------|----------|----------|
| stock_basic | ❌ 受限 | 每天最多访问5次，每分钟最多1次 |
| trade_cal | ❌ 无权限 | 免费账户无访问权限 |
| daily | ⚠️ 有限制 | 可以访问，但有频率和点数限制 |

### 错误信息分析

1. **stock_basic接口**：
   ```
   抱歉，您每天最多访问该接口5次，权限的具体详情访问：https://tushare.pro/document/1?doc_id=108
   ```

2. **trade_cal接口**：
   ```
   抱歉，您没有接口访问权限，权限的具体详情访问：https://tushare.pro/document/1?doc_id=108
   ```

3. **daily接口**：
   - 可以调用，但返回空数据（可能因为查询的日期不是交易日）

## 免费账户限制分析

根据Tushare官方文档，免费账户有以下限制：

### 基础限制
- **每日积分**: 120点
- **每分钟调用**: 最多2次
- **单次数据量**: 最多6000条记录

### 接口权限
| 接口分类 | 免费账户权限 | 备注 |
|----------|-------------|------|
| 股票基础数据 | 部分接口 | stock_basic每日5次限制 |
| 行情数据 | ✅ 完整权限 | daily等行情接口可正常使用 |
| 交易日历 | ❌ 无权限 | 需要付费账户 |
| 财务数据 | ❌ 无权限 | 需要付费账户 |

## 解决方案

### 1. 针对stock_basic接口限制

**问题**: 每天只能调用5次，每分钟只能调用1次

**解决方案**:
- 本地缓存股票基础信息，减少API调用
- 使用系统配置表存储最后更新时间
- 实现智能缓存策略，避免重复调用

**实现策略**:
```python
# 1. 首次运行时获取股票基础信息并缓存
# 2. 后续运行检查缓存是否过期（建议7天更新一次）
# 3. 如果缓存有效，直接使用本地数据
```

### 2. 针对trade_cal接口无权限

**问题**: 免费账户无法访问交易日历接口

**解决方案**:
- 使用公开的交易日历数据源
- 实现本地交易日历数据维护
- 使用节假日API或者静态配置

**替代方案**:
1. **使用Python的交易日历库**:
   ```bash
   pip install pandas-market-calendars
   ```

2. **手动维护交易日历**:
   - 创建本地交易日历表
   - 定期手动更新节假日信息

3. **使用公开数据源**:
   - 网络爬取交易日历信息
   - 使用其他免费API

### 3. 针对daily接口优化

**问题**: 虽然可以访问，但需要优化使用策略

**解决方案**:
- 优先使用按日期批量获取策略
- 实现增量下载，避免重复下载
- 严格控制调用频率

## 优化后的架构设计

### 1. 数据获取策略调整

```python
# 原计划的数据获取流程：
# 1. 获取交易日历 (❌ 无权限)
# 2. 获取股票基础信息 (⚠️ 严格限制)
# 3. 按交易日期获取日线数据 (✅ 可行)

# 优化后的数据获取流程：
# 1. 使用本地交易日历数据
# 2. 缓存股票基础信息，减少API调用
# 3. 按交易日期获取日线数据
```

### 2. 缓存策略

1. **股票基础信息缓存**:
   - 本地SQLite存储
   - 7天更新一次（或手动触发）
   - 增量更新新上市股票

2. **交易日历缓存**:
   - 预置2024-2030年交易日历
   - 手动维护节假日调整
   - 支持用户自定义更新

### 3. 备用方案

如果API限制过于严格，考虑以下备用方案：

1. **使用公开数据源**:
   - 网易财经
   - 新浪财经
   - 东方财富

2. **数据文件导入**:
   - CSV文件批量导入
   - Excel数据处理
   - 第三方数据服务

## 项目配置更新

### 1. 配置文件调整

```json
{
    "data_sources": {
        "primary": "tushare_pro",
        "fallback": ["netease", "sina"],
        "trade_calendar_source": "local"
    },
    "cache_strategy": {
        "stock_basic_cache_days": 7,
        "enable_local_trade_calendar": true,
        "max_api_calls_per_day": 100
    },
    "api_limits": {
        "stock_basic_daily_limit": 5,
        "stock_basic_minute_limit": 1,
        "trade_cal_available": false
    }
}
```

### 2. 数据库表调整

增加缓存控制表：
```sql
CREATE TABLE data_cache_status (
    data_type TEXT PRIMARY KEY,
    last_update_date DATE,
    cache_valid_days INTEGER,
    record_count INTEGER,
    status TEXT DEFAULT 'valid'
);
```

## 实施建议

### 阶段1: 基础功能（当前可实现）
1. ✅ 使用daily接口获取日线数据
2. ✅ 实现本地缓存机制
3. ✅ 手动维护交易日历

### 阶段2: 功能完善
1. 优化API调用策略
2. 实现数据验证和修复
3. 添加数据监控功能

### 阶段3: 扩展方案
1. 集成备用数据源
2. 实现数据质量检查
3. 提供数据导出功能

## 总结

虽然免费账户权限有限制，但通过合理的架构设计和缓存策略，仍然可以实现项目的核心功能：

1. **daily接口可用** - 核心的日线数据获取功能正常
2. **本地缓存策略** - 减少对受限接口的依赖
3. **渐进式实现** - 先实现基础功能，后续逐步完善

这样的设计既满足了项目需求，又适应了免费账户的限制条件。 